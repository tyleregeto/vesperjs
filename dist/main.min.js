"use strict";var te=te||{};te.parseTemplate=function(a,b){"string"==typeof a&&(a={value:a});for(var c=Object.keys(a),d=0;d<c.length;d++){var e=c[d];b=b.replace(new RegExp("{"+e+"}","g"),a[e])}return b},te.newMentionListener=function(a,b){function c(){"string"==typeof a&&(a=document.getElementById(a)),l=a,"textarea"===l.tagName.toLowerCase()?m=te.newMentionTextareaPlugin(l):l.hasAttribute("contentEditable")&&"false"!==l.getAttribute("contentEditable")&&(m=te.newMentionContentEditablePlugin(l)),r=te.newMentionListView(i,m.type(),b.escapeCloseLength||3e3),l.addEventListener("input",e),l.addEventListener("keydown",g),l.addEventListener("click",f)}function d(){l.removeEventListener("input",e),l.removeEventListener("keydown",g),l.removeEventListener("click",f),r.destory(),m.destory()}function e(){window.requestAnimationFrame(h)}function f(){window.requestAnimationFrame(h)}function g(a){var b=!1,c=a.key||a.keyIdentifier;switch(c){case"Up":case"Down":case"Left":case"Right":case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":b=!0}b&&window.requestAnimationFrame(h)}function h(){var a=m.getValue();a||(a={text:"",caretIndex:0}),t=a.data,s=j(a.text,a.caretIndex),s?r.setList(k(s.term),m.getMenuPosition(s.start)):r.setList([])}function i(a){var b=te.parseTemplate(a,o);m.insert(b,s,p,t)}function j(a,b){for(var c=0;q>c;){var d=a.substr(b-c,c+1);if(d[0]===n){if(0===c)return!1;var e=a.substr(b-c+1,c-1),f=e.indexOf(n);return-1!==f&&(e=e.substr(0,f)),0>b-c?!1:{term:e,start:b-c,end:b}}c++}return!1}function k(a){a=a.toLowerCase();for(var c=b.data||[],d=[],e=0;e<c.length;e++){var f=c[e];f.substr(0,a.length).toLowerCase()===a&&d.push(f)}return d}b=b||{};var l=null,m=null,n=b.triggerCharacter||"@",o=b.insertTmpl||n+"{value}",p=b.spaceAfterInsert||!1,q=b.maxLen||20,r=(b.mentionClassName||"te-mention",null),s=null,t=null;return c(),{destory:d}},te.newMentionTextareaPlugin=function(a){function b(){return{text:a.value,caretIndex:a.selectionStart}}function c(c,d,e){var f=b().text;e&&(c+=" "),a.value=f.slice(0,d.start)+c+f.slice(d.end);var g=d.start+c.length;a.selectionStart=g,a.selectionEnd=g}function d(){var b=a.getClientRects()[0];return{top:b.bottom,left:b.left}}function e(){}return{getValue:b,insert:c,destory:e,getMenuPosition:d,type:function(){return"te-mention-textarea"}}},te.newMentionContentEditablePlugin=function(){function a(){var a=window.getSelection(),b={range:a.getRangeAt(0),anchorNode:a.anchorNode};return{text:a.anchorNode.textContent,caretIndex:a.anchorOffset,data:b}}function b(a,b,c,d){d.anchorNode.nodeType!==Node.TEXT_NODE&&console.log("not a text node: ",d.anchorNode);var e=document.createElement("div");e.innerHTML=a,e=e.firstChild;var f=d.range;d.anchorNode.nodeType===Node.TEXT_NODE&&(f.setStart(d.anchorNode,b.start),f.setEnd(d.anchorNode,b.end)),f.deleteContents(),f.insertNode(e);var g=e;c&&(g=document.createTextNode("Â "),e.parentNode.insertBefore(g,e.nextSibling));var h=window.getSelection();h.removeAllRanges(),f=document.createRange(),f.selectNode(g),f.collapse(),h.addRange(f)}function c(a){var b=window.getSelection(),c=b.getRangeAt(0);c.cloneRange(),c.setStart(c.startContainer,a);var d=c.getClientRects();return d&&d[0]?{top:d[0].top,left:d[0].left}:{left:0,top:0}}function d(){}return{getValue:a,insert:b,destory:d,getMenuPosition:c,type:function(){return"te-mention-content-editable"}}},te.newMentionListView=function(a,b,c){function d(){document.body.removeChild(o),window.removeEventListener("keydown",h)}function e(a,b){if(!(Date.now()-r<c)){for(l=a,k=a.length,n=k>0,m=[],j=0;p.firstChild;)p.removeChild(p.firstChild);if(n){o.style.top=b.top,o.style.left=b.left;for(var d=0;d<l.length;d++){var e=l[d],f=document.createElement("li");f.setAttribute("data-te-mention-index",d),0===d&&(f.className="te-active"),f.innerHTML=te.parseTemplate(e,q),p.appendChild(f),m.push(f)}}}}function f(a){var b=null,c=j;if(j=a,0>j?j=0:j>k-1&&(j=k-1),c!==j){for(var d=0;d<m.length;d++)d===c?m[d].className="":d===j&&(b=m[d],b.className="te-active");b&&("function"==typeof b.scrollIntoViewIfNeeded?b.scrollIntoViewIfNeeded(!1):b.scrollIntoView(!1))}}function g(b){var c=l[b];e([]),a(c)}function h(a){if(n){var b=a.key||a.keyIdentifier,c=!1;switch(b){case"Up":case"ArrowUp":c=!0,f(j-1);break;case"Down":case"ArrowDown":c=!0,f(j+1);break;case"Enter":case"Tab":case"U+0009":c=!0,g(j);break;case"Escape":case"U+001B":e([]),r=Date.now()}c&&(a.stopImmediatePropagation(),a.preventDefault())}}function i(a){for(var b=a.target;b&&!b.hasAttribute("data-te-mention-index");)b=b.parentNode;b&&g(parseInt(b.getAttribute("data-te-mention-index"),10)),a.stopImmediatePropagation(),a.preventDefault()}var j=0,k=0,l=null,m=null,n=!1,o=document.createElement("div"),p=document.createElement("ul"),q="<b>Name:</b> {value}",r=0;return p.className="te-mentions-list-results",p.addEventListener("click",i),o.className="te-mentions-list "+b,o.appendChild(p),document.body.appendChild(o),window.addEventListener("keydown",h,!0),{setList:e,destroy:d}},window.requestAnimationFrame||(window.requestAnimationFrame=function(a){setTimeout(a,1e3/30)});