var te=te||{};te.escapeHtml=function(a){var b=document.createTextNode(a),c=document.createElement("div");return c.appendChild(b),c.innerHTML},te.parseTemplate=function(a,b,c){"string"==typeof a&&(a={value:a});for(var d=Object.keys(a),e=0;e<d.length;e++){var f=d[e],g=c?te.escapeHtml(a[f]):a[f];b=b.replace(new RegExp("{"+f+"}","g"),g)}return b},te.newMentionListener=function(a,b){function c(){"string"==typeof a&&(a=document.getElementById(a)),k=a,"textarea"===k.tagName.toLowerCase()?l=te.newMentionTextareaPlugin(k):k.hasAttribute("contentEditable")&&"false"!==k.getAttribute("contentEditable")&&(l=te.newMentionContentEditablePlugin(k)),s=b.view||te.newMentionListView(h,{className:l.name}),k.addEventListener("input",f),k.addEventListener("click",f),k.addEventListener("keydown",e)}function d(){k.removeEventListener("input",f),k.removeEventListener("click",f),k.removeEventListener("keydown",e),s.destory()}function e(a){var b={37:1,38:1,39:1,40:0};b[a.keyCode]&&f()}function f(){window.requestAnimationFrame?window.requestAnimationFrame(g):setTimeout(g,1e3/30)}function g(){var a=l.getValue();a||(a={text:"",caretIndex:0}),u=a.data,t=i(a.text,a.caretIndex),t?s.setList(j(t.term),l.getMenuPosition(t.start)):s.setList([])}function h(a){var b=te.parseTemplate(a,n,r);l.insert(b,t,o,u)}function i(a,b){for(var c=0;p>c;){var d=a.substr(b-c,c+1);if(d[0]===m){if(q>=c)return!1;var e=a.substr(b-c+1,c-1),f=e.indexOf(m);return-1!==f&&(e=e.substr(0,f)),0>b-c?!1:{term:e,start:b-c,end:b}}c++}return!1}function j(a){a=a.toLowerCase();for(var c=b.data||[],d=[],e=0;e<c.length;e++){var f=c[e];f.substr(0,a.length).toLowerCase()===a&&d.push(f)}return d}b=b||{};var k=null,l=null,m=b.triggerCharacter||"@",n=b.insertTmpl||m+"{value}",o=b.spaceAfterInsert||!1,p=b.maxLen||20,q=b.minLen||0,r=b.escapeTmpls!==!1,s=null,t=null,u=null;return c(),{destory:d}},te.newMentionTextareaPlugin=function(a){function b(){return{text:a.value,caretIndex:a.selectionStart}}function c(c,d,e){var f=b().text;e&&(c+=" "),a.value=f.slice(0,d.start)+c+f.slice(d.end);var g=d.start+c.length;a.selectionStart=g,a.selectionEnd=g}function d(){var b=a.getClientRects()[0];return{top:b.bottom,left:b.left}}return{name:"te-mention-textarea",insert:c,getValue:b,getMenuPosition:d}},te.newMentionContentEditablePlugin=function(){function a(){var a=window.getSelection(),b=a.getRangeAt(0);if(!b.collapsed)return!1;var c=a.anchorNode,d=null;"A"===c.parentNode.tagName&&(d=c.parentNode);var e={range:b,anchorNode:c,nodeToReplace:d};return{text:a.anchorNode.textContent,caretIndex:a.anchorOffset,data:e}}function b(a,b,c,d){var e=document.createElement("div");e.innerHTML=a,e=e.firstChild;var f=d.range;d.nodeToReplace?f.selectNode(d.nodeToReplace):d.anchorNode.nodeType===Node.TEXT_NODE&&(f.setStart(d.anchorNode,b.start),f.setEnd(d.anchorNode,b.end)),f.deleteContents(),f.insertNode(e);var g=e;c&&(g=document.createTextNode("Â "),e.parentNode.insertBefore(g,e.nextSibling));var h=window.getSelection();h.removeAllRanges(),f=document.createRange(),f.selectNode(g),f.collapse(),h.addRange(f)}function c(a){var b=window.getSelection(),c=b.getRangeAt(0);c.cloneRange(),c.setStart(c.startContainer,a);var d=c.getClientRects();return d&&d[0]?{top:d[0].top,left:d[0].left}:{left:0,top:0}}return{name:"te-mention-content-editable",insert:b,getValue:a,getMenuPosition:c}},te.newMentionListView=function(a,b){function c(){document.body.removeChild(n),window.removeEventListener("keydown",g)}function d(a,b){if(!(Date.now()-u<p)){for(k=a,j=a.length,m=j>0,l=[],i=0;o.firstChild;)o.removeChild(o.firstChild);if(m){n.style.top=b.top,n.style.left=b.left;for(var c=0;c<k.length;c++){var d=k[c],e=document.createElement("li");e.setAttribute("data-te-mention-index",c),0===c&&(e.className="te-active"),e.innerHTML=te.parseTemplate(d,q,t),o.appendChild(e),l.push(e)}}}}function e(a){var b=null,c=i;if(i=a,0>i?i=0:i>j-1&&(i=j-1),c!==i){for(var d=0;d<l.length;d++)d===c?l[d].className="":d===i&&(b=l[d],b.className="te-active");b&&("function"==typeof b.scrollIntoViewIfNeeded?b.scrollIntoViewIfNeeded(!1):b.scrollIntoView(!1))}}function f(b){var c=k[b];d([]),a(c)}function g(a){if(m){var b=!1;switch(a.keyCode){case 38:b=!0,e(i-1);break;case 40:b=!0,e(i+1);break;case 13:s&&(b=!0,f(i));break;case 9:r&&(b=!0,f(i));break;case 27:d([]),u=Date.now()}b&&(a.stopImmediatePropagation(),a.preventDefault())}}function h(a){for(var b=a.target;b&&!b.hasAttribute("data-te-mention-index");)b=b.parentNode;b&&f(parseInt(b.getAttribute("data-te-mention-index"),10)),a.stopImmediatePropagation(),a.preventDefault()}var i=0,j=0,k=null,l=null,m=!1,n=document.createElement("div"),o=document.createElement("ul"),p=b.escapeCloseLength||3e3,q=b.rowTmpl||"{value}",r=b.tabSelects!==!1,s=b.enterSelects!==!1,t=b.escapeTmpls!==!1,u=0;return o.className="te-mentions-list-results",o.addEventListener("click",h),n.className="te-mentions-list "+(b.className||""),n.appendChild(o),document.body.appendChild(n),window.addEventListener("keydown",g,!0),{setList:d,destroy:c}};